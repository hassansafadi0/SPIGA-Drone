<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimulationView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spiga-simulator</a> &gt; <a href="index.source.html" class="el_package">com.spiga.ui</a> &gt; <span class="el_source">SimulationView.java</span></div><h1>SimulationView.java</h1><pre class="source lang-java linenums">package com.spiga.ui;

import com.spiga.core.ActifMobile;
import com.spiga.core.Point3D;
import com.spiga.env.ZoneOperation;
import com.spiga.mission.GestionnaireEssaim;
import javafx.animation.AnimationTimer;
import javafx.scene.canvas.Canvas;
import javafx.scene.canvas.GraphicsContext;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;

public class SimulationView extends Pane {
    private ZoneOperation zone;
    private GestionnaireEssaim gestionnaire;
    private Canvas canvas;
    private AnimationTimer timer;

<span class="nc" id="L19">    private java.util.List&lt;ActifMobile&gt; selectedAssets = new java.util.ArrayList&lt;&gt;();</span>
<span class="nc" id="L20">    private final double SCALE = 0.9; // 1000 world -&gt; 900 canvas</span>

<span class="nc" id="L22">    public SimulationView(ZoneOperation zone, GestionnaireEssaim gestionnaire) {</span>
<span class="nc" id="L23">        this.zone = zone;</span>
<span class="nc" id="L24">        this.gestionnaire = gestionnaire;</span>
<span class="nc" id="L25">        this.canvas = new Canvas(900, 900); // Square canvas</span>
<span class="nc" id="L26">        getChildren().add(canvas);</span>

        // Redraw on resize
<span class="nc" id="L29">        widthProperty().addListener(evt -&gt; draw());</span>
<span class="nc" id="L30">        heightProperty().addListener(evt -&gt; draw());</span>

        // Handle Mouse Events
<span class="nc" id="L33">        canvas.setOnMouseClicked(e -&gt; {</span>
            try {
<span class="nc" id="L35">                double mx = e.getX();</span>
<span class="nc" id="L36">                double my = e.getY();</span>

<span class="nc bnc" id="L38" title="All 2 branches missed.">                if (e.getButton() == javafx.scene.input.MouseButton.PRIMARY) {</span>
                    // Try to select an asset
<span class="nc" id="L40">                    boolean clickedAsset = handleSelection(mx, my);</span>

                    // If we didn't click an asset, but have one selected, move it
<span class="nc bnc" id="L43" title="All 4 branches missed.">                    if (!clickedAsset &amp;&amp; !selectedAssets.isEmpty()) {</span>
<span class="nc" id="L44">                        handleMoveCommand(mx, my);</span>
                    }
<span class="nc bnc" id="L46" title="All 2 branches missed.">                } else if (e.getButton() == javafx.scene.input.MouseButton.SECONDARY) {</span>
                    // Right click always moves if selected
<span class="nc" id="L48">                    handleMoveCommand(mx, my);</span>
                }
<span class="nc" id="L50">            } catch (Exception ex) {</span>
<span class="nc" id="L51">                System.err.println(&quot;Error handling mouse click: &quot; + ex.getMessage());</span>
<span class="nc" id="L52">                ex.printStackTrace();</span>
<span class="nc" id="L53">            }</span>
<span class="nc" id="L54">        });</span>
<span class="nc" id="L55">    }</span>

    private Runnable onUpdate;

    /**
     * Sets the callback to be run on every simulation update.
     * 
     * @param onUpdate The runnable to execute.
     */
    public void setOnUpdate(Runnable onUpdate) {
<span class="nc" id="L65">        this.onUpdate = onUpdate;</span>
<span class="nc" id="L66">    }</span>

<span class="nc" id="L68">    private long lastUpdate = 0;</span>

    /**
     * Starts the simulation animation timer.
     */
    public void startSimulation() {
<span class="nc" id="L74">        timer = new AnimationTimer() {</span>
            @Override
            public void handle(long now) {
                try {
<span class="nc bnc" id="L78" title="All 2 branches missed.">                    if (now - lastUpdate &gt;= 100_000_000) { // Update every 100ms (10 FPS)</span>
<span class="nc" id="L79">                        update();</span>
<span class="nc" id="L80">                        draw();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                        if (onUpdate != null) {</span>
<span class="nc" id="L82">                            onUpdate.run();</span>
                        }
<span class="nc" id="L84">                        lastUpdate = now;</span>
                    }
<span class="nc" id="L86">                } catch (Exception e) {</span>
<span class="nc" id="L87">                    System.err.println(&quot;Error in animation timer: &quot; + e.getMessage());</span>
<span class="nc" id="L88">                    e.printStackTrace();</span>
<span class="nc" id="L89">                }</span>
<span class="nc" id="L90">            }</span>
        };
<span class="nc" id="L92">        timer.start();</span>
<span class="nc" id="L93">    }</span>

    private boolean handleSelection(double mx, double my) {
        try {
<span class="nc" id="L97">            boolean clickedOnAsset = false;</span>
            // If CTRL is not held, clear selection (simplified logic: assume always
            // multi-select or toggle)
            // For now, let's implement simple toggle behavior

<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (gestionnaire.getFlotte() == null) {</span>
<span class="nc" id="L103">                return false;</span>
            }

<span class="nc bnc" id="L106" title="All 2 branches missed.">            for (ActifMobile actif : gestionnaire.getFlotte()) {</span>
                // Map world to canvas
<span class="nc" id="L108">                double x = actif.getPosition().getX() * SCALE;</span>
<span class="nc" id="L109">                double y = actif.getPosition().getY() * SCALE;</span>

                // Simple hit detection (radius 20 for easier clicking)
<span class="nc bnc" id="L112" title="All 4 branches missed.">                if (Math.abs(mx - x) &lt; 20 &amp;&amp; Math.abs(my - y) &lt; 20) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    if (selectedAssets.contains(actif)) {</span>
<span class="nc" id="L114">                        selectedAssets.remove(actif);</span>
<span class="nc" id="L115">                        System.out.println(&quot;Deselected: &quot; + actif.getId());</span>
                    } else {
<span class="nc" id="L117">                        selectedAssets.add(actif);</span>
<span class="nc" id="L118">                        System.out.println(&quot;Selected: &quot; + actif.getId());</span>
                    }
<span class="nc" id="L120">                    draw();</span>
<span class="nc" id="L121">                    clickedOnAsset = true;</span>
<span class="nc" id="L122">                    break; // Only select one at a time per click</span>
                }
<span class="nc" id="L124">            }</span>

            // If clicked on empty space, clear selection?
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (!clickedOnAsset) {</span>
                // Optional: Clear selection if clicking on empty space
                // selectedAssets.clear();
                // draw();
            }

<span class="nc" id="L133">            return clickedOnAsset;</span>
<span class="nc" id="L134">        } catch (Exception e) {</span>
<span class="nc" id="L135">            System.err.println(&quot;Error handling selection: &quot; + e.getMessage());</span>
<span class="nc" id="L136">            e.printStackTrace();</span>
<span class="nc" id="L137">            return false;</span>
        }
    }

    /**
     * Handles the movement command for the selected asset.
     * Validates the target position based on terrain constraints.
     * 
     * @param mx Mouse X coordinate.
     * @param my Mouse Y coordinate.
     */
    private void handleMoveCommand(double mx, double my) {
        try {
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (selectedAssets.isEmpty())</span>
<span class="nc" id="L151">                return;</span>

            // Map canvas back to world
<span class="nc" id="L154">            double wx = mx / SCALE;</span>
<span class="nc" id="L155">            double wy = my / SCALE;</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">            for (ActifMobile asset : selectedAssets) {</span>
                try {
<span class="nc" id="L159">                    double wz = asset.getPosition().getZ(); // Keep current altitude/depth</span>

                    // Constraints
                    // 1. Marine assets cannot go on land
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    if (asset instanceof com.spiga.core.ActifMarin) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                        if (zone.isLand(new Point3D(wx, wy, 0))) {</span>
<span class="nc" id="L165">                            System.out.println(&quot;Cannot move marine asset &quot; + asset.getId() + &quot; to land!&quot;);</span>
<span class="nc" id="L166">                            continue;</span>
                        }
                    }
                    // 2. Land vehicles cannot go into water
<span class="nc bnc" id="L170" title="All 2 branches missed.">                    if (asset instanceof com.spiga.core.VehiculeTerrestre) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                        if (!zone.isLand(new Point3D(wx, wy, 0))) {</span>
<span class="nc" id="L172">                            System.out.println(&quot;Cannot move land vehicle &quot; + asset.getId() + &quot; to water!&quot;);</span>
<span class="nc" id="L173">                            continue;</span>
                        }
                    }

<span class="nc" id="L177">                    asset.setTarget(new Point3D(wx, wy, wz));</span>
<span class="nc" id="L178">                    System.out.println(&quot;Moving &quot; + asset.getId() + &quot; to &quot; + wx + &quot;, &quot; + wy);</span>
<span class="nc" id="L179">                } catch (Exception e) {</span>
<span class="nc" id="L180">                    System.err.println(&quot;Error moving asset &quot; + asset.getId() + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L181">                }</span>
<span class="nc" id="L182">            }</span>
<span class="nc" id="L183">        } catch (Exception e) {</span>
<span class="nc" id="L184">            System.err.println(&quot;Error handling move command: &quot; + e.getMessage());</span>
<span class="nc" id="L185">            e.printStackTrace();</span>
<span class="nc" id="L186">        }</span>
<span class="nc" id="L187">    }</span>

    /**
     * Updates the state of all assets.
     * Moves assets towards their targets and checks for arrival.
     */
    private void update() {
        try {
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (gestionnaire.getFlotte() == null) {</span>
<span class="nc" id="L196">                return;</span>
            }

<span class="nc bnc" id="L199" title="All 2 branches missed.">            for (ActifMobile actif : gestionnaire.getFlotte()) {</span>
                try {
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    if (actif.getTarget() != null) {</span>
<span class="nc" id="L202">                        actif.deplacer(actif.getTarget(), zone);</span>

                        // Stop if reached (simple check)
<span class="nc" id="L205">                        double dx = actif.getTarget().getX() - actif.getPosition().getX();</span>
<span class="nc" id="L206">                        double dy = actif.getTarget().getY() - actif.getPosition().getY();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        if (Math.sqrt(dx * dx + dy * dy) &lt; 5.0) { // Tolerance</span>
<span class="nc" id="L208">                            actif.setTarget(null); // Stop</span>
<span class="nc" id="L209">                            actif.setEtat(com.spiga.core.EtatOperationnel.AU_SOL); // Reset state</span>
                        }
                    }
<span class="nc" id="L212">                } catch (Exception e) {</span>
<span class="nc" id="L213">                    System.err.println(&quot;Error updating asset &quot; + actif.getId() + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L214">                }</span>
<span class="nc" id="L215">            }</span>
<span class="nc" id="L216">        } catch (Exception e) {</span>
<span class="nc" id="L217">            System.err.println(&quot;Error in update loop: &quot; + e.getMessage());</span>
<span class="nc" id="L218">            e.printStackTrace();</span>
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">    }</span>

    /**
     * Draws the simulation state on the canvas.
     * Renders the map (water, islands) and assets.
     */
    private void draw() {
        try {
<span class="nc" id="L228">            GraphicsContext gc = canvas.getGraphicsContext2D();</span>

            // Clear background (Water)
<span class="nc" id="L231">            gc.setFill(Color.LIGHTBLUE);</span>
<span class="nc" id="L232">            gc.fillRect(0, 0, canvas.getWidth(), canvas.getHeight());</span>

            // Draw Islands
<span class="nc" id="L235">            gc.setFill(Color.LIGHTGREEN);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (zone.getIslands() != null) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                for (ZoneOperation.Island island : zone.getIslands()) {</span>
                    try {
<span class="nc bnc" id="L239" title="All 2 branches missed.">                        if (island.isCircle()) {</span>
<span class="nc" id="L240">                            gc.fillOval(island.getX() * SCALE - (island.getW() * SCALE),</span>
<span class="nc" id="L241">                                    island.getY() * SCALE - (island.getW() * SCALE),</span>
<span class="nc" id="L242">                                    island.getW() * SCALE * 2, island.getW() * SCALE * 2);</span>
                        } else {
<span class="nc" id="L244">                            gc.fillRect(island.getX() * SCALE, island.getY() * SCALE, island.getW() * SCALE,</span>
<span class="nc" id="L245">                                    island.getH() * SCALE);</span>
                        }
<span class="nc" id="L247">                    } catch (Exception e) {</span>
<span class="nc" id="L248">                        System.err.println(&quot;Error drawing island: &quot; + e.getMessage());</span>
<span class="nc" id="L249">                    }</span>
<span class="nc" id="L250">                }</span>
            }

            // Draw Assets
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (gestionnaire.getFlotte() != null) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                for (ActifMobile actif : gestionnaire.getFlotte()) {</span>
                    try {
<span class="nc" id="L257">                        drawAsset(gc, actif);</span>
<span class="nc" id="L258">                    } catch (Exception e) {</span>
<span class="nc" id="L259">                        System.err.println(&quot;Error drawing asset &quot; + actif.getId() + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L260">                    }</span>
<span class="nc" id="L261">                }</span>
            }
<span class="nc" id="L263">        } catch (Exception e) {</span>
<span class="nc" id="L264">            System.err.println(&quot;Error in draw method: &quot; + e.getMessage());</span>
<span class="nc" id="L265">            e.printStackTrace();</span>
<span class="nc" id="L266">        }</span>
<span class="nc" id="L267">    }</span>

    private void drawAsset(GraphicsContext gc, ActifMobile actif) {
<span class="nc" id="L270">        double x = actif.getPosition().getX() * SCALE;</span>
<span class="nc" id="L271">        double y = actif.getPosition().getY() * SCALE;</span>
<span class="nc" id="L272">        String type = actif.getClass().getSimpleName();</span>

<span class="nc" id="L274">        gc.setFill(getColorForType(actif));</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (selectedAssets.contains(actif)) {</span>
<span class="nc" id="L277">            gc.setStroke(Color.RED);</span>
<span class="nc" id="L278">            gc.setLineWidth(2);</span>
<span class="nc" id="L279">            gc.strokeOval(x - 15, y - 15, 30, 30);</span>
        }

<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (type.contains(&quot;Reconnaissance&quot;)) {</span>
            // Triangle for plane
<span class="nc" id="L284">            gc.fillPolygon(new double[] { x, x - 10, x + 10 }, new double[] { y - 10, y + 10, y + 10 }, 3);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        } else if (type.contains(&quot;Logistique&quot;)) {</span>
            // Square/Quad for drone
<span class="nc" id="L287">            gc.fillRect(x - 8, y - 8, 16, 16);</span>
            // Rotors
<span class="nc" id="L289">            gc.setStroke(Color.BLACK);</span>
<span class="nc" id="L290">            gc.strokeOval(x - 12, y - 12, 10, 10);</span>
<span class="nc" id="L291">            gc.strokeOval(x + 2, y - 12, 10, 10);</span>
<span class="nc" id="L292">            gc.strokeOval(x - 12, y + 2, 10, 10);</span>
<span class="nc" id="L293">            gc.strokeOval(x + 2, y + 2, 10, 10);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        } else if (type.contains(&quot;Surface&quot;)) {</span>
            // Boat shape
<span class="nc" id="L296">            gc.fillPolygon(new double[] { x - 12, x + 12, x + 6, x - 6 }, new double[] { y - 6, y - 6, y + 6, y + 6 },</span>
                    4);
<span class="nc bnc" id="L298" title="All 2 branches missed.">        } else if (type.contains(&quot;SousMarin&quot;)) {</span>
            // Ellipse for sub
<span class="nc" id="L300">            gc.fillOval(x - 14, y - 7, 28, 14);</span>
            // Periscope
<span class="nc" id="L302">            gc.strokeLine(x, y - 7, x, y - 14);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        } else if (type.contains(&quot;Terrestre&quot;)) {</span>
            // Car shape (Rectangle)
<span class="nc" id="L305">            gc.fillRect(x - 10, y - 6, 20, 12);</span>
            // Wheels
<span class="nc" id="L307">            gc.setFill(Color.BLACK);</span>
<span class="nc" id="L308">            gc.fillOval(x - 8, y + 6, 4, 4);</span>
<span class="nc" id="L309">            gc.fillOval(x + 4, y + 6, 4, 4);</span>
<span class="nc" id="L310">            gc.fillOval(x - 8, y - 8, 4, 4);</span>
<span class="nc" id="L311">            gc.fillOval(x + 4, y - 8, 4, 4);</span>
        } else {
<span class="nc" id="L313">            gc.fillOval(x - 5, y - 5, 10, 10);</span>
        }

<span class="nc" id="L316">        gc.setFill(Color.BLACK);</span>
<span class="nc" id="L317">        gc.fillText(actif.getId(), x + 12, y);</span>
<span class="nc" id="L318">    }</span>

    private Color getColorForType(ActifMobile actif) {
<span class="nc" id="L321">        String type = actif.getClass().getSimpleName();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (type.contains(&quot;Reconnaissance&quot;))</span>
<span class="nc" id="L323">            return Color.BLUE;</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (type.contains(&quot;Logistique&quot;))</span>
<span class="nc" id="L325">            return Color.GREEN;</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (type.contains(&quot;Surface&quot;))</span>
<span class="nc" id="L327">            return Color.ORANGE;</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (type.contains(&quot;SousMarin&quot;))</span>
<span class="nc" id="L329">            return Color.DARKBLUE;</span>
<span class="nc" id="L330">        return Color.RED;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>